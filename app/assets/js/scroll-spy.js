const INIT_DELAY=100,INIT_DELAY_SHORT=50,INIT_DELAY_LONG=300,TOP_OFFSET=120,HEADING_PROXIMITY=200;document.addEventListener("DOMContentLoaded",function(){setTimeout(initScrollSpy,INIT_DELAY),document.body.addEventListener("htmx:afterSwap",function(e){e.detail.target.id==="content-section"&&setTimeout(initScrollSpy,INIT_DELAY)}),document.body.addEventListener("htmx:afterSettle",function(e){e.detail.target.id==="variable-sidebar-container"&&setTimeout(initScrollSpy,INIT_DELAY_SHORT)})});function cleanupScrollSpy(){window.scrollSpyActive&&(window.scrollObserver&&(window.scrollObserver.disconnect(),window.scrollObserver=null),window.removeEventListener("resize",window.scrollSpyResizeHandler),window.scrollSpyActive=!1)}function initScrollSpy(){try{const s=document.querySelectorAll(".blog-toc .toc-list a"),a=document.querySelector("article");if(!s.length||!a)return;setupTocLinksMobileHandler();const r={};s.forEach(e=>{const t=e.getAttribute("href");t&&t.startsWith("#")&&(r[t.substring(1)]=!0)});const o=Array.from(a.querySelectorAll("[id]")).filter(e=>r[e.id]);if(!o.length)return;cleanupScrollSpy();let i=null;const n=[];function t(){n.length=0,o.forEach(e=>{n.push({id:e.id,top:e.getBoundingClientRect().top+window.scrollY})}),n.sort((e,t)=>e.top-t.top)}t();function e(){const t=window.scrollY;let e=null;for(let s=n.length-1;s>=0;s--)if(t+TOP_OFFSET>=n[s].top){e=n[s].id;break}if(!e&&n.length>0&&Math.abs(t-n[0].top)<HEADING_PROXIMITY&&(e=n[0].id),e){const t=document.getElementById(e);if(!i||e!==i.id){s.forEach(e=>{e.classList.remove("active")});const n=document.querySelector(`.blog-toc .toc-list a[href="#${e}"]`);n&&(n.classList.add("active"),i=t)}}}const c={rootMargin:`-${TOP_OFFSET}px 0px -70% 0px`,threshold:[0,.1,.5,1]};window.scrollObserver=new IntersectionObserver(t=>{window.scrollSpyAnimating||(window.scrollSpyAnimating=!0,window.requestAnimationFrame(()=>{t.some(e=>e.isIntersecting)&&e(),window.scrollSpyAnimating=!1}))},c),o.forEach(e=>{window.scrollObserver.observe(e)}),window.scrollSpyResizeHandler=function(){t(),e()},window.addEventListener("resize",window.scrollSpyResizeHandler,{passive:!0}),window.scrollSpyActive=!0,window.addEventListener("load",function(){t(),e()}),setTimeout(function(){t(),e()},INIT_DELAY_LONG),window.scrollSpyScrollHandler=function(){window.scrollSpyAnimating||(window.scrollSpyAnimating=!0,window.requestAnimationFrame(function(){e(),window.scrollSpyAnimating=!1}))},window.addEventListener("scroll",window.scrollSpyScrollHandler,{passive:!0})}catch(e){console.error("Error initializing scroll spy:",e)}}